# ===========================================
# GITHUB ACTIONS WORKFLOW - DEPLOY SSH (PADRÃƒO)
# Link Chart Frontend - Deploy Direto via SSH
# ===========================================
#
# ğŸ¯ OBJETIVO:
#   Deploy automÃ¡tico da aplicaÃ§Ã£o Next.js diretamente no servidor
#   DigitalOcean via SSH, sem uso de containers Docker.
#
# ğŸš€ QUANDO EXECUTA:
#   - Push para branch 'main'
#   - ExecuÃ§Ã£o manual via workflow_dispatch
#
# ğŸ“‹ PRÃ‰-REQUISITOS:
#   - Secrets configurados no GitHub:
#     * SSH_PRIVATE_KEY: Chave SSH privada para acesso ao servidor
#     * SSH_HOST: IP do servidor (ex: 134.209.33.182)
#     * SSH_USER: UsuÃ¡rio para deploy (ex: deploy)
#     * DEPLOY_PATH: Caminho da aplicaÃ§Ã£o (ex: /var/www/linkchart-frontend)
#
# ğŸ”§ CONFIGURAÃ‡ÃƒO DO SERVIDOR:
#   - Node.js 22+ instalado
#   - Git configurado
#   - UsuÃ¡rio 'deploy' com permissÃµes sudo para systemctl
#   - ServiÃ§o systemd 'linkchart-frontend' configurado
#   - Nginx configurado como proxy reverso
#
# âš¡ PERFORMANCE:
#   - Build time: ~2-3 minutos
#   - Deploy time: ~1-2 minutos
#   - Total: ~3-5 minutos
#
# ===========================================

name: ğŸš€ Deploy via SSH (PadrÃ£o)

on:
    push:
        branches: [main]
    workflow_dispatch:
        inputs:
            skip_build:
                description: 'Pular validaÃ§Ã£o de build (apenas para emergÃªncias)'
                required: false
                default: false
                type: boolean

# Definir variÃ¡veis globais
env:
    NODE_VERSION: '22'
    DEPLOY_TIMEOUT: '300' # 5 minutos timeout

# Definir permissÃµes necessÃ¡rias
permissions:
    contents: read

jobs:
    # ===========================================
    # JOB 1: VALIDAÃ‡ÃƒO E BUILD LOCAL
    # Valida o cÃ³digo antes do deploy para evitar falhas no servidor
    # ===========================================
    validate:
        name: ğŸ” ValidaÃ§Ã£o e Build
        runs-on: ubuntu-latest
        if: ${{ !inputs.skip_build }}

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # NecessÃ¡rio para git log

            - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: ğŸ“¦ Install dependencies
              run: |
                  echo "ğŸ“¦ Instalando dependÃªncias..."
                  npm ci --prefer-offline --no-audit --silent
                  echo "âœ… DependÃªncias instaladas com sucesso"

            - name: ğŸ” ValidaÃ§Ã£o de estrutura
              run: |
                  echo "ğŸ” Validando estrutura do projeto..."
                  npm run validate
              continue-on-error: true # Warnings nÃ£o devem bloquear

            - name: ğŸ—ï¸ Test Build
              run: |
                  echo "ğŸ—ï¸ Testando build de produÃ§Ã£o..."
                  npm run build
                  echo "âœ… Build concluÃ­do com sucesso"

                  # Mostrar informaÃ§Ãµes do build
                  echo "ğŸ“Š InformaÃ§Ãµes do build:"
                  ls -la .next/ | head -10
                  du -sh .next/
              env:
                  NODE_ENV: production
                  NEXT_TELEMETRY_DISABLED: 1

            - name: ğŸ“‹ Build Summary
              run: |
                  echo "## ğŸ—ï¸ Build Validation Summary" >> $GITHUB_STEP_SUMMARY
                  echo "- **Node.js**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Build Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
                  echo "- **Bundle Size**: $(du -sh .next/ | cut -f1)" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

    # ===========================================
    # JOB 2: DEPLOY VIA SSH NO SERVIDOR DE PRODUÃ‡ÃƒO
    # Executa o deploy diretamente no servidor DigitalOcean
    # ===========================================
    deploy:
        name: ğŸš€ Deploy no Servidor
        runs-on: ubuntu-latest
        needs: validate
        if: always() && (needs.validate.result == 'success' || inputs.skip_build)
        environment: production
        timeout-minutes: 10

        steps:
            - name: ğŸ”‘ Configurar SSH
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: ğŸŒ Verificar conectividade
              run: |
                  echo "ğŸ” Verificando conectividade com o servidor..."

                  # Adicionar host Ã s known_hosts
                  ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

                  # Testar conexÃ£o SSH
                  ssh -o ConnectTimeout=10 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'ConexÃ£o SSH OK'"
                  echo "âœ… Conectividade confirmada"

            - name: ğŸš€ Executar Deploy no Servidor
              run: |
                  echo "ğŸ¯ Iniciando deploy no servidor de produÃ§Ã£o..."
                  echo "ğŸ“ Servidor: ${{ secrets.SSH_HOST }}"
                  echo "ğŸ‘¤ UsuÃ¡rio: ${{ secrets.SSH_USER }}"
                  echo "ğŸ“ Caminho: ${{ secrets.DEPLOY_PATH }}"
                  echo ""

                  # Executar deploy no servidor
                  ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
                    set -e
                    
                    # Configurar ambiente
                    export NODE_ENV=production
                    export NEXT_TELEMETRY_DISABLED=1
                    
                    echo "ğŸš€ [$(date)] Iniciando deploy via GitHub Actions..."
                    echo "ğŸ“‹ Commit: ${{ github.sha }}"
                    echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
                    echo ""
                    
                    # Navegar para diretÃ³rio da aplicaÃ§Ã£o
                    cd ${{ secrets.DEPLOY_PATH }}
                    
                    # Backup do estado atual (caso precise reverter)
                    echo "ğŸ’¾ Criando backup do estado atual..."
                    git log -1 --oneline > /tmp/deploy-backup-${{ github.run_id }}.txt
                    
                    # Atualizar cÃ³digo
                    echo "ğŸ“¥ Atualizando cÃ³digo do repositÃ³rio..."
                    git fetch origin --quiet
                    git reset --hard origin/main --quiet
                    
                    # Mostrar mudanÃ§as
                    echo "ğŸ“ Ãšltimo commit aplicado:"
                    git log -1 --oneline
                    echo ""
                    
                    # Instalar/atualizar dependÃªncias
                    echo "ğŸ“¦ Instalando dependÃªncias..."
                    npm ci --silent
                    
                    # Build da aplicaÃ§Ã£o
                    echo "ğŸ—ï¸ Fazendo build da aplicaÃ§Ã£o..."
                    npm run build
                    
                    # Verificar se o build foi bem-sucedido
                    if [ ! -d ".next" ]; then
                      echo "âŒ Erro: Build falhou - diretÃ³rio .next nÃ£o encontrado"
                      exit 1
                    fi
                    
                    echo "âœ… Build concluÃ­do com sucesso"
                    
                    # Reiniciar serviÃ§o
                    echo "ğŸ”„ Reiniciando serviÃ§o da aplicaÃ§Ã£o..."
                    sudo systemctl restart linkchart-frontend
                    
                    # Aguardar inicializaÃ§Ã£o
                    echo "â³ Aguardando inicializaÃ§Ã£o do serviÃ§o..."
                    sleep 3
                    
                    # Verificar status do serviÃ§o
                    echo "ğŸ” Verificando status do serviÃ§o..."
                    if sudo systemctl is-active --quiet linkchart-frontend; then
                      echo "âœ… ServiÃ§o estÃ¡ ativo"
                    else
                      echo "âŒ Erro: ServiÃ§o nÃ£o estÃ¡ ativo"
                      sudo systemctl status linkchart-frontend --no-pager
                      exit 1
                    fi
                    
                    # Health check da aplicaÃ§Ã£o
                    echo "ğŸ§ª Executando health check..."
                    sleep 2
                    
                    for i in {1..3}; do
                      if curl -f -s http://localhost/health > /dev/null; then
                        echo "âœ… Health check passou (tentativa $i)"
                        break
                      else
                        echo "âš ï¸ Health check falhou (tentativa $i/3)"
                        if [ $i -eq 3 ]; then
                          echo "âŒ Erro: Health check falhou apÃ³s 3 tentativas"
                          exit 1
                        fi
                        sleep 2
                      fi
                    done
                    
                    echo ""
                    echo "ğŸ‰ [$(date)] Deploy concluÃ­do com sucesso!"
                    echo "ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: http://${{ secrets.SSH_HOST }}"
                  EOF

                  echo ""
                  echo "âœ… Deploy executado com sucesso no servidor!"

            - name: ğŸ“Š Resumo do Deploy
              if: always()
              run: |
                  echo "## ğŸš€ Resumo do Deploy" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ğŸ“‹ InformaÃ§Ãµes do Deploy" >> $GITHUB_STEP_SUMMARY
                  echo "- **ğŸ–¥ï¸ Servidor**: ${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **ğŸ“ Caminho**: ${{ secrets.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **ğŸ‘¤ UsuÃ¡rio**: ${{ secrets.SSH_USER }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **ğŸ“‹ Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **ğŸŒ¿ Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **â° Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
                  echo "- **ğŸƒ Workflow**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ğŸŒ Acesso Ã  AplicaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
                  echo "- **URL Principal**: http://${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Health Check**: http://${{ secrets.SSH_HOST }}/health" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### âœ… Status: Deploy ConcluÃ­do com Sucesso!" >> $GITHUB_STEP_SUMMARY

    # ===========================================
    # JOB 3: NOTIFICAÃ‡ÃƒO E STATUS FINAL
    # Consolida o status de todos os jobs e envia notificaÃ§Ãµes
    # ===========================================
    notify:
        name: ğŸ“± Status Final
        runs-on: ubuntu-latest
        needs: [validate, deploy]
        if: always()

        steps:
            - name: ğŸ“Š Consolidar Status Final
              run: |
                  echo "## ğŸ“Š Status Final do Pipeline" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Status dos jobs
                  echo "### ğŸ” Status dos Jobs" >> $GITHUB_STEP_SUMMARY

                  # ValidaÃ§Ã£o
                  if [ "${{ needs.validate.result }}" == "success" ]; then
                    echo "- **âœ… ValidaÃ§Ã£o**: Passou" >> $GITHUB_STEP_SUMMARY
                  elif [ "${{ needs.validate.result }}" == "skipped" ]; then
                    echo "- **â­ï¸ ValidaÃ§Ã£o**: Pulada (skip_build=true)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "- **âŒ ValidaÃ§Ã£o**: Falhou" >> $GITHUB_STEP_SUMMARY
                  fi

                  # Deploy
                  if [ "${{ needs.deploy.result }}" == "success" ]; then
                    echo "- **âœ… Deploy**: ConcluÃ­do com sucesso" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "- **âŒ Deploy**: Falhou ou foi pulado" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY

                  # Status geral
                  if [ "${{ needs.deploy.result }}" == "success" ]; then
                    echo "### ğŸ‰ **DEPLOY REALIZADO COM SUCESSO!**" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "ğŸŒ **AplicaÃ§Ã£o estÃ¡ online**: http://${{ secrets.SSH_HOST }}" >> $GITHUB_STEP_SUMMARY
                    echo "ğŸ” **Monitoramento**: http://${{ secrets.SSH_HOST }}/health" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "### âŒ **DEPLOY FALHOU**" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "ğŸ”§ **AÃ§Ã£o necessÃ¡ria**: Verifique os logs dos jobs acima" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "---" >> $GITHUB_STEP_SUMMARY
                  echo "ğŸ“… **Data**: $(date -u)" >> $GITHUB_STEP_SUMMARY
                  echo "ğŸ”— **Workflow**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

            # Futuro: Adicionar notificaÃ§Ãµes para Slack/Discord
            # - name: ğŸ“± Slack Notification
            #   if: always()
            #   uses: 8398a7/action-slack@v3
            #   with:
            #     status: ${{ job.status }}
            #     channel: '#deployments'
            #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
