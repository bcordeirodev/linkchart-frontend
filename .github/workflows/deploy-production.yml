name: ðŸš€ Deploy Frontend to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '22'
  DEPLOY_HOST: 138.197.121.81
  PROJECT_PATH: /var/www/linkchartapp-frontend
  DOCKER_COMPOSE_FILE: docker/docker-compose.production.yml

jobs:
  deploy:
    name: ðŸ—ï¸ Deploy Frontend to Production Server
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 20

    steps:
    - name: ðŸ“¦ Checkout code
      uses: actions/checkout@v4

    - name: ðŸš€ Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.DEPLOY_HOST }}
        username: root
        key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
        script: |
          echo "ðŸš€ Iniciando deploy do frontend..."
          
          # Criar diretÃ³rio se nÃ£o existir
          mkdir -p ${{ env.PROJECT_PATH }}
          cd ${{ env.PROJECT_PATH }}
          
          # Verificar e corrigir docker-compose se necessÃ¡rio
          echo "ðŸ”§ Verificando docker-compose..."
          if grep -q "image:" docker/docker-compose.production.yml; then
            echo "âŒ Docker-compose tem 'image:' - corrigindo..."
            sed -i '/image:/d' docker/docker-compose.production.yml
            sed -i '/version:/d' docker/docker-compose.production.yml
            echo "âœ… Docker-compose corrigido"
          else
            echo "âœ… Docker-compose jÃ¡ estÃ¡ correto"
          fi
          
          # Fazer backup da versÃ£o atual (se existir)
          echo "ðŸ’¾ Fazendo backup da versÃ£o atual..."
          docker tag linkchartapp-frontend:latest linkchartapp-frontend:backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || echo "No previous version to backup"
          
          # Parar containers antigos
          echo "ðŸ›‘ Parando containers antigos..."
          docker compose -f docker/docker-compose.production.yml down 2>/dev/null || echo "No containers to stop"
          
          # Limpar imagens conflitantes
          echo "ðŸ§¹ Limpando imagens conflitantes..."
          docker rmi linkchartapp-frontend:latest 2>/dev/null || echo "No conflicting image to remove"
          
          # Build da aplicaÃ§Ã£o
          echo "ðŸ—ï¸ Building aplicaÃ§Ã£o..."
          docker compose -f docker/docker-compose.production.yml build --no-cache
          
          # Iniciar serviÃ§os
          echo "ðŸš€ Iniciando serviÃ§os..."
          docker compose -f docker/docker-compose.production.yml up -d
          
          # Aguardar inicializaÃ§Ã£o
          echo "â³ Aguardando inicializaÃ§Ã£o..."
          sleep 30
          
          # Verificar se estÃ¡ funcionando
          echo "ðŸ” Verificando se estÃ¡ funcionando..."
          sleep 10
          if curl -f http://localhost:3000/ 2>/dev/null; then
            echo "âœ… AplicaÃ§Ã£o funcionando corretamente"
          else
            echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ funcionando"
            docker logs linkchartapp-frontend
            exit 1
          fi
          
          # Limpar imagens antigas
          echo "ðŸ§¹ Limpando imagens antigas..."
          docker image prune -f
          docker images | grep linkchartapp-frontend | tail -n +4 | awk '{print $3}' | xargs -r docker rmi 2>/dev/null || echo "No old images to clean"
          
          echo "âœ… Deploy completed successfully!"
