name: 🚀 Deploy Frontend to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '22'
  DEPLOY_HOST: 138.197.121.81
  PROJECT_PATH: /var/www/linkchartapp-frontend
  DOCKER_COMPOSE_FILE: docker/docker-compose.production.yml

jobs:
  deploy:
    name: 🏗️ Deploy Frontend to Production Server
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 20

    steps:
    - name: 📦 Checkout code
      uses: actions/checkout@v4

    - name: 🚀 Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.DEPLOY_HOST }}
        username: root
        key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
        script: |
          echo "🚀 Iniciando deploy do frontend..."
          
          # Criar diretório se não existir
          mkdir -p ${{ env.PROJECT_PATH }}
          cd ${{ env.PROJECT_PATH }}
          
          # Verificar e corrigir docker-compose se necessário
          echo "🔧 Verificando docker-compose..."
          if grep -q "image:" docker/docker-compose.production.yml; then
            echo "❌ Docker-compose tem 'image:' - corrigindo..."
            sed -i '/image:/d' docker/docker-compose.production.yml
            sed -i '/version:/d' docker/docker-compose.production.yml
            echo "✅ Docker-compose corrigido"
          else
            echo "✅ Docker-compose já está correto"
          fi
          
          # Fazer backup da versão atual (se existir)
          echo "💾 Fazendo backup da versão atual..."
          docker tag linkchartapp-frontend:latest linkchartapp-frontend:backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || echo "No previous version to backup"
          
          # Parar containers antigos
          echo "🛑 Parando containers antigos..."
          docker compose -f docker/docker-compose.production.yml down 2>/dev/null || echo "No containers to stop"
          
          # Limpar imagens conflitantes
          echo "🧹 Limpando imagens conflitantes..."
          docker rmi linkchartapp-frontend:latest 2>/dev/null || echo "No conflicting image to remove"
          
          # Build da aplicação
          echo "🏗️ Building aplicação..."
          docker compose -f docker/docker-compose.production.yml build --no-cache
          
          # Iniciar serviços
          echo "🚀 Iniciando serviços..."
          docker compose -f docker/docker-compose.production.yml up -d
          
          # Aguardar inicialização
          echo "⏳ Aguardando inicialização..."
          sleep 30
          
          # Verificar se está funcionando
          echo "🔍 Verificando se está funcionando..."
          sleep 10
          if curl -f http://localhost:3000/ 2>/dev/null; then
            echo "✅ Aplicação funcionando corretamente"
          else
            echo "❌ Aplicação não está funcionando"
            docker logs linkchartapp-frontend
            exit 1
          fi
          
          # Limpar imagens antigas
          echo "🧹 Limpando imagens antigas..."
          docker image prune -f
          docker images | grep linkchartapp-frontend | tail -n +4 | awk '{print $3}' | xargs -r docker rmi 2>/dev/null || echo "No old images to clean"
          
          echo "✅ Deploy completed successfully!"
